---
title: Koa2中上传图片并返回url给前端
date: 2019-03-25 09:19:26
tags:
- NodeJs
- Koa
categories:
- 零碎点
---

#### 安装依赖

- **koa-body**

``` shell
$ npm install koa-body --save
```

> ``koa-body``是一个基于koa框架的处理请求的中间件，可以处理请求中的文件。同时其他请求信息的封装与``koa-bodyparser``一致（可以取代``koa-bodyparser``）

- **koa-static**

``` shell
$ npm install koa-static --save
```

> ``koa-static``是一个基于koa框架、公开静态资源服务的中间件（为了外网可以直接访问图片资源）

***

#### 配置koa-body

``uploadUtil``是自己写的一个工具类，主要作用是用于判断文件类型是否符合预期、根据日期生成保存图片的路径等功能

``` javascript
const Koa = require('koa');
const koaBody = require('koa-body');
const path = require('path');
const { uploadUtil } = require('./utils');
const app = new Koa();

app.use(koaBody({
    multipart: true,
    formidable: {
        multiples: false,   // 是否可以一次上传多个文件
        maxFileSize: 1024 * 1024,   // 设置上传文件大小最大限制1M
        keepExtensions: true,   // 是否保留扩展名
        onFileBegin: (name,file) => {
            const ext = uploadUtil.getUploadFileExt(file.name); // 获取文件后缀
            if ( !uploadUtil.checkFileType(file.name)) {
                throw new Error('上传文件不符合类型');
            }
            const dir = path.join(process.cwd(), `public/templateImage/${uploadUtil.getUploadDirName()}`);  // 最终要保存到的文件夹目录
            uploadUtil.checkDirExist(dir);  // 检查文件夹是否存在如果不存在则新建文件夹
            file.path = `${dir}/${uploadUtil.getUploadFileName()}.${ext}`;  // 重新覆盖 file.path 属性
        },
        onError: (err) => {
            console.log(err);
        }
    }
}));
```

***

#### 配置koa-static

``` javascript
const Koa = require('koa');
const koaStatic = require('koa-static');
const app = new Koa();

app.use(koaStatic(process.cwd()));  // 入参为项目根目录(注意启动服务时应从项目根目录启动)
```

> - __dirname： 获得当前执行文件所在目录的完整目录名
> - __filename： 获得当前执行文件的带有完整绝对路径的文件名
> - process.cwd()：获得当前执行node命令时候的文件夹目录名
> - ./：不使用require时候，./与process.cwd()一样，使用require时候，与__dirname一样

``koa-static``入参保持一个原则，既如果你期望路径从某个目录开始，那么就传入这个目录的父级目录路径，因为``koa-static``会自动帮你把传入的路径省略，直接挂在到IP之后。我的项目目录如下（我的静态资源是public目录）,为了偷懒少截取一次字符串，所以使用了process.cwd(),实际上这样会有风险。

```
project/
    -public/
        -2019xxxx(根据日期生成的文件夹，便于管理)
    -src/
        -index.js(入口文件)
```

***

#### 路由业务层（返回图片url给前端）

``` javascript
const Router = require('koa-router');
const templateRouter = new Router();
const { resp } = require('../utils');   // resp是对response进行封装的工具类

templateRouter.post('/uploadPic', async (ctx) => {
    let url = ctx.request.files.img.path;   // 其中img为前后端约定好的key
    url = url.substring(url.indexOf('public')); // 返回从public目录开始的相对路径
    resp.sendSuccessResponse(ctx, {
      url: url,
    });
});
module.exports = templateRouter;
```

***

#### 前端发起请求

``` html
<input name="img" type="file" accept="image/*" @change="onFileChange($event)" style="display: none">
```

> file标签发生改变的时候将事件对象传递进去（Vue）

``` javascript
onFileChange (ev) {
    const fd = new FormData();
    fd.append('img', e.target.files[0]);
    return request.post('/template/uploadPic', fd, {
        headers: { "Content-Type": "multipart/form-data" }
    });
}
```

> axios发起文件上传请求